<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Audio Masking Tool</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet" />
    <style>
      :root {
        --color-main: #1f1f1f;
        --color-highlight2: rgb(209, 209, 209);
        --color-pink: #d98abb;
        --color-pink-bright: #ebabd2;
      }
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Inter", sans-serif;
        color: var(--color-highlight2);
        accent-color: var(--color-pink);
      }
      body {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: space-around;
        background-color: var(--color-main);
        padding: 16px;
        height: 100dvh;
      }
      h1 {
        font-size: 6rem;
        text-align: center;
      }
      button {
        width: 100%;
        max-width: 400px;
        height: 40vh;
        font-size: 4rem;
        user-select: none;
        background: var(--color-pink);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        border-radius: 48px;
      }
      button span {
        color: var(--color-main);
      }
      .material-symbols-outlined {
        font-variation-settings: "FILL" 0, "wght" 400, "GRAD" 0, "opsz" 24;
        font-size: 12rem;
      }
    </style>
  </head>
  <body>
    <h1>Audio Masking Tool</h1>
    <button id="intercom">
      <span id="intercom-icon" class="material-symbols-outlined"> mic </span>
      <span id="intercom-label">Start Intercom</span>
    </button>
    <button id="playNoise">
      <span id="noise-icon" class="material-symbols-outlined"> volume_up </span>
      <span id="noise-label">Start Noise</span>
    </button>

    <script>
      const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const outputGain = audioCtx.createGain();
      outputGain.connect(audioCtx.destination);

      const noiseTrack = {
        volume: 0.1,
        fadeTime: 2,
        gainNode: audioCtx.createGain(),
        source: null,
        buffer: null,
        isPlaying: false
      };
      noiseTrack.gainNode.connect(outputGain);

      const intercomState = {
        stream: null,
        source: null,
        isConnected: false,
      };

      async function loadNoiseBuffer() {
        const res = await fetch("noise.wav");
        const arrayBuffer = await res.arrayBuffer();
        noiseTrack.buffer = await audioCtx.decodeAudioData(arrayBuffer);
      }

      async function playNoise() {
        if (!noiseTrack.buffer) await loadNoiseBuffer();
        noiseTrack.source = audioCtx.createBufferSource();
        noiseTrack.source.buffer = noiseTrack.buffer;
        noiseTrack.source.loop = true;
        noiseTrack.source.connect(noiseTrack.gainNode);
        noiseTrack.gainNode.gain.setValueAtTime(noiseTrack.volume, audioCtx.currentTime);
        noiseTrack.source.start();
        noiseTrack.isPlaying = true;

        document.getElementById("playNoise").onclick = stopNoise;
        document.getElementById("noise-label").innerText = "Stop Noise";
        document.getElementById("noise-icon").innerText = "volume_off";
      }

      function stopNoise() {
        if (noiseTrack.source) noiseTrack.source.stop();
        noiseTrack.isPlaying = false;

        document.getElementById("playNoise").onclick = playNoise;
        document.getElementById("noise-label").innerText = "Start Noise";
        document.getElementById("noise-icon").innerText = "volume_up";
      }

      function fadeNoiseTo(volume, time = 0.5) {
        const now = audioCtx.currentTime;
        noiseTrack.gainNode.gain.cancelScheduledValues(now);
        noiseTrack.gainNode.gain.linearRampToValueAtTime(volume, now + time);
      }

      async function setupIntercomOnce() {
        if (intercomState.stream) return;
        intercomState.stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        intercomState.source = audioCtx.createMediaStreamSource(intercomState.stream);
      }

      async function startIntercom() {
        await audioCtx.resume();
        await setupIntercomOnce();

        if (!intercomState.isConnected) {
          intercomState.source.connect(outputGain);
          intercomState.isConnected = true;
        }

        fadeNoiseTo(noiseTrack.volume / 2, noiseTrack.fadeTime);
        document.getElementById("intercom").onclick = stopIntercom;
        document.getElementById("intercom-label").innerText = "Stop Intercom";
        document.getElementById("intercom-icon").innerText = "mic_off";
      }

      function stopIntercom() {
        if (intercomState.isConnected && intercomState.source) {
          intercomState.source.disconnect();
          intercomState.isConnected = false;
        }

        fadeNoiseTo(noiseTrack.volume, noiseTrack.fadeTime);
        document.getElementById("intercom").onclick = startIntercom;
        document.getElementById("intercom-label").innerText = "Start Intercom";
        document.getElementById("intercom-icon").innerText = "mic";
      }

      document.getElementById("playNoise").onclick = playNoise;
      document.getElementById("intercom").onclick = startIntercom;
    </script>
  </body>
</html>
