<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Audio Masking Tool</title>
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap"
      rel="stylesheet"
    />

    <link rel="stylesheet" href="./style.css" />
  </head>
  <body>
    <h1>Audio Masking Tool</h1>

    <table>
      <tr>
        <td>
          <button id="intercom">
            <span id="intercom-icon" class="material-symbols-outlined"> mic </span>
            <span id="intercom-label">Start<br/>Intercom</span>
          </button>
        </td>
        <td>
          <button id="playNoise">
            <span id="noise-icon" class="material-symbols-outlined"> volume_up </span>
            <span id="noise-label">Start<br/>Noise</span>
          </button>
        </td>
      </tr>

      <tr>
        <td>
          <label>
            Intercom Volume
            <input type="range" />
          </label>
        </td>

        <td>
          <label>
            Noise Volume
            <input type="range" />
          </label>
        </td>
      </tr>

      <tr>
        <td></td>
        <td>
          <fieldset>
            <legend>Noise Flavor</legend>
            <label class="radio-label">
              <input type="radio" name="flavor">
              White Noise
            </label>
            
            <label class="radio-label">
              <input type="radio" name="flavor">
              Pink Noise
            </label>
            
            <label class="radio-label">
              <input type="radio" name="flavor">
              Brown Noise
            </label>
          </fieldset>
        </td>
      </tr>
    </table>

    <script>
      const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const outputGain = audioCtx.createGain();
      outputGain.connect(audioCtx.destination);

      const noiseTrack = {
        volume: 0.1,
        fadeTime: 2,
        gainNode: audioCtx.createGain(),
        source: null,
        buffer: null,
        isPlaying: false,
      };
      noiseTrack.gainNode.connect(outputGain);

      const intercomState = {
        stream: null,
        source: null,
        isConnected: false,
      };

      async function loadNoiseBuffer() {
        const res = await fetch("noise.wav");
        const arrayBuffer = await res.arrayBuffer();
        noiseTrack.buffer = await audioCtx.decodeAudioData(arrayBuffer);
      }

      async function playNoise() {
        if (!noiseTrack.buffer) await loadNoiseBuffer();
        noiseTrack.source = audioCtx.createBufferSource();
        noiseTrack.source.buffer = noiseTrack.buffer;
        noiseTrack.source.loop = true;
        noiseTrack.source.connect(noiseTrack.gainNode);
        noiseTrack.gainNode.gain.setValueAtTime(
          noiseTrack.volume,
          audioCtx.currentTime
        );
        noiseTrack.source.start();
        noiseTrack.isPlaying = true;

        document.getElementById("playNoise").onclick = stopNoise;
        document.getElementById("noise-label").innerText = "Stop Noise";
        document.getElementById("noise-icon").innerText = "volume_off";
      }

      function stopNoise() {
        if (noiseTrack.source) noiseTrack.source.stop();
        noiseTrack.isPlaying = false;

        document.getElementById("playNoise").onclick = playNoise;
        document.getElementById("noise-label").innerText = "Start Noise";
        document.getElementById("noise-icon").innerText = "volume_up";
      }

      function fadeNoiseTo(volume, time = 0.5) {
        const now = audioCtx.currentTime;
        noiseTrack.gainNode.gain.cancelScheduledValues(now);
        noiseTrack.gainNode.gain.linearRampToValueAtTime(volume, now + time);
      }

      function isAndroid() {
        return /android/i.test(navigator.userAgent);
      }

      async function setupIntercomOnce() {
        if (intercomState.stream) return;

        const constraints = {
          audio: isAndroid()
            ? {
                echoCancellation: false,
                noiseSuppression: false,
                autoGainControl: false,
              }
            : true, // default on desktop
        };

        intercomState.stream = await navigator.mediaDevices.getUserMedia(
          constraints
        );
        intercomState.source = audioCtx.createMediaStreamSource(
          intercomState.stream
        );
      }

      async function startIntercom() {
        await audioCtx.resume();
        await setupIntercomOnce();

        if (!intercomState.isConnected) {
          intercomState.source.connect(outputGain);
          intercomState.isConnected = true;
        }

        fadeNoiseTo(noiseTrack.volume / 2, noiseTrack.fadeTime);
        document.getElementById("intercom").onclick = stopIntercom;
        document.getElementById("intercom-label").innerText = "Stop Intercom";
        document.getElementById("intercom-icon").innerText = "mic_off";
      }

      function stopIntercom() {
        if (intercomState.isConnected && intercomState.source) {
          intercomState.source.disconnect();
          intercomState.isConnected = false;
        }

        fadeNoiseTo(noiseTrack.volume, noiseTrack.fadeTime);
        document.getElementById("intercom").onclick = startIntercom;
        document.getElementById("intercom-label").innerText = "Start Intercom";
        document.getElementById("intercom-icon").innerText = "mic";
      }

      document.getElementById("playNoise").onclick = playNoise;
      document.getElementById("intercom").onclick = startIntercom;
    </script>
  </body>
</html>
